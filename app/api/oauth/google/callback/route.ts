import { NextResponse } from 'next/server'; import { cookies } from 'next/headers'; export async function GET(req:Request){ const u=new URL(req.url); const code=u.searchParams.get('code'); if(!code) return new NextResponse('Missing code',{status:400}); const body=new URLSearchParams({ code, client_id: process.env.GOOGLE_CLIENT_ID!, client_secret: process.env.GOOGLE_CLIENT_SECRET!, redirect_uri: process.env.GOOGLE_REDIRECT_URI!, grant_type:'authorization_code' }); const tr=await fetch('https://oauth2.googleapis.com/token',{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body }); if(!tr.ok){ const t=await tr.text(); return new NextResponse('OAuth exchange failed: '+t,{status:400}); } const tokens=await tr.json(); const resp=NextResponse.redirect(new URL('/', req.url)); resp.cookies.set('google_connected','1',{httpOnly:true,secure:true,sameSite:'lax',path:'/'}); if(tokens.access_token) resp.cookies.set('google_access', tokens.access_token, {httpOnly:true,secure:true,sameSite:'lax',path:'/'}); if(tokens.refresh_token) resp.cookies.set('google_refresh', tokens.refresh_token, {httpOnly:true,secure:true,sameSite:'lax',path:'/'}); return resp; }