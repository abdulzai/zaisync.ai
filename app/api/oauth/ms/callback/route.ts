import { NextResponse } from 'next/server'; import { cookies } from 'next/headers'; export async function GET(req:Request){ const u=new URL(req.url); const code=u.searchParams.get('code'); if(!code) return new NextResponse('Missing code',{status:400}); const tenant=process.env.MS_TENANT_ID||'common'; const body=new URLSearchParams({ client_id: process.env.MS_CLIENT_ID!, client_secret: process.env.MS_CLIENT_SECRET!, grant_type:'authorization_code', code, redirect_uri: process.env.MS_REDIRECT_URI!, scope:'offline_access Mail.ReadWrite openid profile email' }); const tr=await fetch(`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/token`,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body }); if(!tr.ok){ const t=await tr.text(); return new NextResponse('MS OAuth exchange failed: '+t,{status:400}); } const tokens=await tr.json(); const resp=NextResponse.redirect(new URL('/', req.url)); resp.cookies.set('ms_connected','1',{httpOnly:true,secure:true,sameSite:'lax',path:'/'}); if(tokens.access_token) resp.cookies.set('ms_access', tokens.access_token, {httpOnly:true,secure:true,sameSite:'lax',path:'/'}); if(tokens.refresh_token) resp.cookies.set('ms_refresh', tokens.refresh_token, {httpOnly:true,secure:true,sameSite:'lax',path:'/'}); return resp; }